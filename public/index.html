<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>LINE è¨Šæ¯æ’ç¨‹å·¥å…·</title>
</head>
<body>
  <h2>LINE è¨Šæ¯æ’ç¨‹å·¥å…·</h2> 

  <label>ç¾¤çµ„åç¨±ï¼ˆå¯è¤‡é¸ï¼‰ï¼š</label>
  <select id="groupSelect" multiple size="5" style="width: 200px;"></select>
  <br /><br />

  <label>è¨Šæ¯æ¨™é¡Œï¼š</label>
  <input type="text" id="title" value="ä»˜æ¬¾æé†’" />
  <br /><br />

  <label>è¨Šæ¯é¡å‹ï¼š</label>
  <select id="templateType">
    <option value="æ”¶æ¬¾é€šçŸ¥">æ”¶æ¬¾é€šçŸ¥</option>
    <option value="å…¥å¸³é€šçŸ¥">å…¥å¸³é€šçŸ¥</option>
    <option value="ç™¼ç¥¨å¯„é€é€šçŸ¥">ç™¼ç¥¨å¯„é€é€šçŸ¥</option>
    <option value="è‡ªæˆ‘ä»‹ç´¹">è‡ªæˆ‘ä»‹ç´¹</option>
    <option value="å°ˆæ¡ˆé€²åº¦è©¢å•">å°ˆæ¡ˆé€²åº¦è©¢å•</option>
    <option value="æ”¾å‡é€šçŸ¥">æ”¾å‡é€šçŸ¥</option>
    <option value="æœƒè­°æé†’">æœƒè­°æé†’</option>
    <option value="è‡ªè¨‚">è‡ªè¨‚</option>
  </select>
  <br /><br />

  <label>å¹£åˆ¥ï¼š</label>
  <input type="text" id="currency" value="NT$" />
  <br /><br />

  <label>é‡‘é¡ï¼š</label>
  <input type="number" id="amount" value="1200" />
  <br /><br />

  <label>ç™¼é€æ™‚é–“ï¼š</label>
  <input type="datetime-local" id="sendAt" />
  <br /><br />

  <label>è‡ªè¨‚è¨Šæ¯å…§å®¹ï¼ˆå¦‚æœé¸è‡ªè¨‚ï¼‰ï¼š</label>
  <textarea id="customContent" rows="4" cols="50"></textarea>
  <br /><br />

  <button onclick="sendMessage()">é€å‡ºæ’ç¨‹</button>

  <hr />
  <h3>â° å·²æ’ç¨‹è¨Šæ¯</h3>
  <ul id="scheduleList"></ul>

  <script>
    let groupMap = {};

    async function loadGroups() {
      try {
        const res = await fetch('/groupMap.json');
        const data = await res.json();
        const select = document.getElementById('groupSelect');
        data.forEach(group => {
          const option = document.createElement('option');
          option.value = group.name;
          option.textContent = group.name;
          select.appendChild(option);
          groupMap[group.name] = group.id;
        });
      } catch (err) {
        alert('ç„¡æ³•è¼‰å…¥ç¾¤çµ„åå–®');
      }
    }

    async function sendMessage() {
      try {
        const selectedNames = Array.from(document.getElementById('groupSelect').selectedOptions)
          .map(opt => opt.value);

        if (selectedNames.length === 0) {
          alert('è«‹é¸æ“‡è‡³å°‘ä¸€å€‹ç¾¤çµ„');
          return;
        }

        const body = {
          groupNames: selectedNames,
          templateType: document.getElementById('templateType').value,
          title: document.getElementById('title').value,
          currency: document.getElementById('currency').value,
          amount: document.getElementById('amount').value,
          sendAt: new Date(document.getElementById('sendAt').value).toISOString(),
          content: document.getElementById('customContent').value
        };

        const res = await fetch('/send-message', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });

        const text = await res.text();
        try {
          const data = JSON.parse(text);
          alert(data.message || 'æ’ç¨‹æˆåŠŸ');
          loadSchedules(); // æ›´æ–°åˆ—è¡¨
        } catch (e) {
          alert('æ’ç¨‹è¨­ç½®å¤±æ•—ï¼šå¾Œç«¯æœªå›å‚³ JSON\n' + text);
        }
      } catch (err) {
        alert('æ’ç¨‹è¨­ç½®å¤±æ•—ï¼š' + err.message);
      }
    }

    async function loadSchedules() {
      try {
        const res = await fetch('/schedules');
        const schedules = await res.json();
        const ul = document.getElementById('scheduleList');
        ul.innerHTML = '';

        schedules.forEach(item => {
          const li = document.createElement('li');
          li.innerHTML = `
            ğŸ“¨ ${item.title} â†’ ${item.groupNames.join(', ')} <br>
            ğŸ•’ ${new Date(item.sendAt).toLocaleString()}
            <button onclick="deleteSchedule('${item.id}')">åˆªé™¤</button>
            <br><br>
          `;
          ul.appendChild(li);
        });
      } catch (err) {
        alert('è¼‰å…¥æ’ç¨‹å¤±æ•—');
      }
    }

    async function deleteSchedule(id) {
      if (confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†æ’ç¨‹å—ï¼Ÿ')) {
        await fetch(`/schedules/${id}`, { method: 'DELETE' });
        alert('åˆªé™¤æˆåŠŸ');
        loadSchedules();
      }
    }

    // âœ… åˆå§‹è¼‰å…¥
    loadGroups();
    loadSchedules();
  </script>
</body>
</html>
